{% extends 'layouts/base.html' %}
{% load static %}

{% block content %}

  <!-- Uploaded Files Container -->
  <div class="w-full px-6 py-6 mx-auto">
    
    <!-- Page Header -->
    <div class="flex flex-wrap -mx-3 mb-6">
      <div class="w-full max-w-full px-3">
        <div class="relative flex flex-col min-w-0 break-words bg-white shadow-soft-xl rounded-2xl bg-clip-border">
          <div class="flex-auto p-6">
            <div class="flex flex-wrap -mx-3">
              <div class="flex-none w-2/3 max-w-full px-3">
                <div>
                  <h1 class="mb-2 font-bold text-2xl">Uploaded Files</h1>
                  <p class="mb-0 font-sans leading-normal text-sm">Manage and monitor your data uploads.</p>
                </div>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="flex space-x-2">
                  <a href="{% url 'analytics:dashboard' %}" 
                     class="inline-block px-4 py-2 text-xs font-bold text-center text-white uppercase align-middle transition-all bg-gradient-to-tl from-slate-600 to-slate-300 border-0 rounded-lg shadow-soft-md bg-150 leading-pro ease-soft-in tracking-tight-soft hover:shadow-soft-xs hover:scale-102">
                    <i class="fas fa-arrow-left mr-1"></i> Dashboard
                  </a>
                  <a href="{% url 'analytics:file_upload' %}" 
                     class="inline-block px-4 py-2 text-xs font-bold text-center text-white uppercase align-middle transition-all bg-gradient-to-tl from-purple-700 to-pink-500 border-0 rounded-lg shadow-soft-md bg-150 leading-pro ease-soft-in tracking-tight-soft hover:shadow-soft-xs hover:scale-102">
                    <i class="fas fa-upload mr-1"></i> Upload File
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters and Search -->
    <div class="flex flex-wrap -mx-3 mb-6">
      <div class="w-full max-w-full px-3">
        <div class="relative flex flex-col min-w-0 break-words bg-white shadow-soft-xl rounded-2xl bg-clip-border">
          <div class="border-black/12.5 mb-0 rounded-t-2xl border-b-0 border-solid bg-white p-6 pb-0">
            <h6>Search & Filter</h6>
          </div>
          <div class="flex-auto p-6">
            <form method="get" class="flex flex-wrap gap-4 items-end">
              <!-- Search -->
              <div class="flex-1 min-w-64">
                <label for="search" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700">Search</label>
                <input type="text" name="search" id="search" value="{{ request.GET.search }}"
                       class="focus:shadow-soft-primary-outline text-sm leading-5.6 ease-soft block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all placeholder:text-gray-500 focus:border-fuchsia-300 focus:outline-none"
                       placeholder="Search by filename...">
              </div>

              <!-- Status Filter -->
              <div class="min-w-48">
                <label for="status" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700">Status</label>
                <select name="status" id="status" 
                        class="focus:shadow-soft-primary-outline text-sm leading-5.6 ease-soft block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all focus:border-fuchsia-300 focus:outline-none">
                  <option value="">All Statuses</option>
                  <option value="PENDING" {% if request.GET.status == 'PENDING' %}selected{% endif %}>Pending</option>
                  <option value="PROCESSING" {% if request.GET.status == 'PROCESSING' %}selected{% endif %}>Processing</option>
                  <option value="MAPPED" {% if request.GET.status == 'MAPPED' %}selected{% endif %}>Mapped</option>
                  <option value="COMPLETED" {% if request.GET.status == 'COMPLETED' %}selected{% endif %}>Completed</option>
                  <option value="ERROR" {% if request.GET.status == 'ERROR' %}selected{% endif %}>Error</option>
                </select>
              </div>

              <!-- Date Filter -->
              <div class="min-w-48">
                <label for="date_from" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700">Date From</label>
                <input type="date" name="date_from" id="date_from" value="{{ request.GET.date_from }}"
                       class="focus:shadow-soft-primary-outline text-sm leading-5.6 ease-soft block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all focus:border-fuchsia-300 focus:outline-none">
              </div>

              <!-- Action Buttons -->
              <div class="flex space-x-2">
                <button type="submit" 
                        class="inline-block px-4 py-2 text-xs font-bold text-center text-white uppercase align-middle transition-all bg-gradient-to-tl from-blue-600 to-cyan-400 border-0 rounded-lg shadow-soft-md bg-150 leading-pro ease-soft-in tracking-tight-soft hover:shadow-soft-xs hover:scale-102">
                  <i class="fas fa-search mr-1"></i> Search
                </button>
                <a href="{% url 'analytics:upload_list' %}" 
                   class="inline-block px-4 py-2 text-xs font-bold text-center text-white uppercase align-middle transition-all bg-gradient-to-tl from-slate-600 to-slate-300 border-0 rounded-lg shadow-soft-md bg-150 leading-pro ease-soft-in tracking-tight-soft hover:shadow-soft-xs hover:scale-102">
                  <i class="fas fa-refresh mr-1"></i> Reset
                </a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload Cards -->
    {% if uploads %}
      <div class="flex flex-wrap -mx-3">
        {% for upload in uploads %}
          <div class="w-full max-w-full px-3 mb-6 md:w-1/2 lg:w-1/3 md:flex-none">
            <div class="relative flex flex-col min-w-0 break-words bg-white shadow-soft-xl rounded-2xl bg-clip-border transition-all duration-300 hover:shadow-soft-2xl hover:scale-102">
              <!-- Card Header -->
              <div class="border-black/12.5 mb-0 rounded-t-2xl border-b-0 border-solid bg-white p-6 pb-0">
                <div class="flex items-start justify-between">
                  <div class="flex-1">
                    <h6 class="truncate font-semibold" title="{{ upload.file.name }}">
                      {{ upload.file.name|truncatechars:25 }}
                    </h6>
                    {% if upload.description %}
                      <p class="text-sm text-slate-400 mt-1">{{ upload.description|truncatechars:50 }}</p>
                    {% endif %}
                  </div>
                  
                  <!-- Status Badge -->
                  <span class="px-2 py-1 text-xs font-medium rounded-full ml-2
                             {% if upload.status == 'COMPLETED' %}bg-gradient-to-tl from-green-600 to-lime-400 text-white
                             {% elif upload.status == 'PROCESSING' %}bg-gradient-to-tl from-yellow-600 to-orange-400 text-white
                             {% elif upload.status == 'MAPPED' %}bg-gradient-to-tl from-blue-600 to-cyan-400 text-white
                             {% elif upload.status == 'ERROR' %}bg-gradient-to-tl from-red-600 to-rose-400 text-white
                             {% else %}bg-gradient-to-tl from-slate-600 to-slate-300 text-white{% endif %}">
                    {% if upload.status == 'COMPLETED' %}
                      <i class="ni ni-check-bold mr-1"></i>
                    {% elif upload.status == 'PROCESSING' %}
                      <i class="ni ni-time-alarm mr-1"></i>
                    {% elif upload.status == 'MAPPED' %}
                      <i class="ni ni-settings-gear-65 mr-1"></i>
                    {% elif upload.status == 'ERROR' %}
                      <i class="ni ni-fat-remove mr-1"></i>
                    {% else %}
                      <i class="ni ni-single-copy-04 mr-1"></i>
                    {% endif %}
                    {{ upload.get_status_display }}
                  </span>
                </div>
              </div>

              <!-- Card Body -->
              <div class="flex-auto p-6">
                <!-- Progress Bar -->
                {% if upload.status == 'PROCESSING' or upload.status == 'COMPLETED' %}
                  <div class="mb-4">
                    <div class="flex justify-between text-xs text-slate-400 mb-1">
                      <span>Progress</span>
                      <span>{{ upload.processed_rows|default:0 }} / {{ upload.total_rows|default:0 }} rows</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                      {% widthratio upload.processed_rows upload.total_rows 100 as progress %}
                      <div class="bg-gradient-to-r from-blue-600 to-cyan-400 h-2 rounded-full transition-all duration-300" 
                           style="width: {{ progress|default:0 }}%"></div>
                    </div>
                  </div>
                {% endif %}

                <!-- File Stats -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                  <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <p class="text-sm font-semibold text-slate-700">{{ upload.total_rows|default:0 }}</p>
                    <p class="text-xs text-slate-400">Total Rows</p>
                  </div>
                  <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <p class="text-sm font-semibold text-slate-700">{{ upload.processed_rows|default:0 }}</p>
                    <p class="text-xs text-slate-400">Processed</p>
                  </div>
                </div>

                <!-- Upload Date -->
                <div class="text-xs text-slate-400 mb-4">
                  <i class="ni ni-calendar-grid-58 mr-1"></i>
                  Uploaded {{ upload.created_at|date:"M d, Y H:i" }}
                </div>

                <!-- Error Message -->
                {% if upload.status == 'ERROR' and upload.error_log %}
                  <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                    <p class="text-sm text-red-700">
                      <i class="ni ni-support-16 mr-1"></i>
                      {{ upload.error_log.0|truncatechars:60 }}
                    </p>
                  </div>
                {% endif %}

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-2">
                  {% if upload.status == 'PENDING' %}
                    <a href="{% url 'analytics:column_mapping' upload.pk %}" 
                       class="inline-block px-3 py-1 text-xs font-bold text-center text-white uppercase align-middle transition-all bg-gradient-to-tl from-blue-600 to-cyan-400 border-0 rounded-lg shadow-soft-md bg-150 leading-pro ease-soft-in tracking-tight-soft hover:shadow-soft-xs hover:scale-102">
                      <i class="ni ni-settings-gear-65 mr-1"></i> Map Columns
                    </a>
                  {% elif upload.status == 'MAPPED' %}
                    <form method="post" action="{% url 'analytics:process_upload' upload.pk %}" class="inline">
                      {% csrf_token %}
                      <button type="submit" 
                              class="inline-block px-3 py-1 text-xs font-bold text-center text-white uppercase align-middle transition-all bg-gradient-to-tl from-green-600 to-lime-400 border-0 rounded-lg shadow-soft-md bg-150 leading-pro ease-soft-in tracking-tight-soft hover:shadow-soft-xs hover:scale-102">
                        <i class="ni ni-button-play mr-1"></i> Process
                      </button>
                    </form>
                  {% endif %}
                  
                  <a href="{% url 'analytics:upload_detail' upload_id=upload.pk %}"
                     class="text-slate-400 font-bold text-xs mr-3">
                    View
                  </a>
                  
                  <a href="{% url 'analytics:upload_delete' upload_id=upload.pk %}"
                     class="inline-block px-3 py-1 text-xs font-bold text-center text-white uppercase align-middle transition-all bg-gradient-to-tl from-red-600 to-rose-400 border-0 rounded-lg shadow-soft-md bg-150 leading-pro ease-soft-in tracking-tight-soft hover:shadow-soft-xs hover:scale-102">
                    <i class="ni ni-fat-remove mr-1"></i> Delete
                  </a>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <!-- Empty State -->
      <div class="flex flex-wrap -mx-3">
        <div class="w-full max-w-full px-3">
          <div class="relative flex flex-col min-w-0 break-words bg-white shadow-soft-xl rounded-2xl bg-clip-border">
            <div class="flex-auto p-6">
              <div class="text-center py-12">
                <div class="w-20 h-20 mx-auto mb-6 flex items-center justify-center rounded-full bg-gradient-to-tl from-slate-600 to-slate-300 text-white">
                  <i class="ni ni-folder-17 text-3xl"></i>
                </div>
                <h6 class="mb-4 font-semibold text-slate-700">No uploads found</h6>
                <p class="text-slate-400 mb-6">You haven't uploaded any files yet. Start by uploading your first billing data file.</p>
                <a href="{% url 'analytics:file_upload' %}" 
                   class="inline-block px-6 py-3 text-xs font-bold text-center text-white uppercase align-middle transition-all bg-gradient-to-tl from-purple-700 to-pink-500 border-0 rounded-lg shadow-soft-md bg-150 leading-pro ease-soft-in tracking-tight-soft hover:shadow-soft-xs hover:scale-102">
                  <i class="ni ni-cloud-upload-96 mr-2"></i> Upload Your First File
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}

    <!-- Pagination -->
    {% if is_paginated %}
      <div class="flex flex-wrap -mx-3 mt-6">
        <div class="w-full max-w-full px-3">
          <div class="relative flex flex-col min-w-0 break-words bg-white shadow-soft-xl rounded-2xl bg-clip-border">
            <div class="flex-auto p-6">
              <div class="flex items-center justify-between">
                <div class="text-sm text-slate-500">
                  Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} uploads
                </div>
                <div class="flex space-x-1">
                  {% if page_obj.has_previous %}
                    <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}" 
                       class="inline-block px-3 py-1 text-xs font-bold text-center text-white uppercase align-middle transition-all bg-gradient-to-tl from-slate-600 to-slate-300 border-0 rounded-lg shadow-soft-md bg-150 leading-pro ease-soft-in tracking-tight-soft hover:shadow-soft-xs hover:scale-102">
                      First
                    </a>
                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}" 
                       class="inline-block px-3 py-1 text-xs font-bold text-center text-white uppercase align-middle transition-all bg-gradient-to-tl from-slate-600 to-slate-300 border-0 rounded-lg shadow-soft-md bg-150 leading-pro ease-soft-in tracking-tight-soft hover:shadow-soft-xs hover:scale-102">
                      Previous
                    </a>
                  {% endif %}
                  
                  <span class="inline-block px-3 py-1 text-xs font-bold text-center text-white uppercase align-middle bg-gradient-to-tl from-purple-700 to-pink-500 border-0 rounded-lg shadow-soft-md">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                  </span>
                  
                  {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}" 
                       class="inline-block px-3 py-1 text-xs font-bold text-center text-white uppercase align-middle transition-all bg-gradient-to-tl from-slate-600 to-slate-300 border-0 rounded-lg shadow-soft-md bg-150 leading-pro ease-soft-in tracking-tight-soft hover:shadow-soft-xs hover:scale-102">
                      Next
                    </a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}" 
                       class="inline-block px-3 py-1 text-xs font-bold text-center text-white uppercase align-middle transition-all bg-gradient-to-tl from-slate-600 to-slate-300 border-0 rounded-lg shadow-soft-md bg-150 leading-pro ease-soft-in tracking-tight-soft hover:shadow-soft-xs hover:scale-102">
                      Last
                    </a>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}

    {% include 'includes/footer.html' %}

  </div>

{% endblock content %} 